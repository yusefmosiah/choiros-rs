#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<'EOF'
Usage: replay-provider-401.sh --artifact <path> [--gateway <url>] [--token <token>]

Replays a provider-gateway 401 debug artifact generated by hypervisor/provider_gateway.rs.

Examples:
  ./scripts/ops/replay-provider-401.sh --artifact /tmp/choiros-provider-401-*.log
  ./scripts/ops/replay-provider-401.sh --artifact /tmp/choiros-provider-401-x.log \
      --gateway http://127.0.0.1:9090 --token grind-provider-gateway-token-v1
EOF
}

ARTIFACT=""
GATEWAY_BASE="${CHOIR_PROVIDER_GATEWAY_BASE_URL:-http://127.0.0.1:9090}"
TOKEN="${CHOIR_PROVIDER_GATEWAY_TOKEN:-}"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --artifact)
      ARTIFACT="${2:-}"
      shift 2
      ;;
    --gateway)
      GATEWAY_BASE="${2:-}"
      shift 2
      ;;
    --token)
      TOKEN="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [ -z "$ARTIFACT" ] || [ ! -f "$ARTIFACT" ]; then
  echo "Missing/invalid --artifact path" >&2
  exit 1
fi

if [ -z "$TOKEN" ]; then
  echo "Missing gateway token. Pass --token or set CHOIR_PROVIDER_GATEWAY_TOKEN." >&2
  exit 1
fi

upstream_url="$(sed -n 's/^upstream_url=//p' "$ARTIFACT" | head -n1)"
sandbox_id="$(sed -n 's/^sandbox_id=//p' "$ARTIFACT" | head -n1)"
user_id="$(sed -n 's/^user_id=//p' "$ARTIFACT" | head -n1)"
model="$(sed -n 's/^model=//p' "$ARTIFACT" | head -n1)"

if [ -z "$upstream_url" ] || [ -z "$sandbox_id" ] || [ -z "$user_id" ] || [ -z "$model" ]; then
  echo "Artifact missing required metadata fields" >&2
  exit 1
fi

request_body="$(awk '/^request_body:/{flag=1; next} /^response_body:/{flag=0} flag {print}' "$ARTIFACT")"
if [ -z "$request_body" ]; then
  echo "Artifact missing request_body block" >&2
  exit 1
fi

gateway_code="$(curl -sS -o /tmp/replay-gateway.json -w "%{http_code}" \
  "${GATEWAY_BASE%/}/provider/v1/forward/v1/messages" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "x-choiros-upstream-base-url: ${upstream_url%/}/" \
  -H "x-choiros-model: ${model}" \
  -H "x-choiros-sandbox-id: ${sandbox_id}" \
  -H "x-choiros-user-id: ${user_id}" \
  -H "x-choiros-sandbox-role: live" \
  -H "Content-Type: application/json" \
  -d "$request_body" || true)"

echo "gateway_status=${gateway_code}"
head -c 240 /tmp/replay-gateway.json
echo
