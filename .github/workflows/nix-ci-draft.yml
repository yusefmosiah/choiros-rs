name: Nix CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: nix-ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nix-build:
    name: Build ${{ matrix.name }} flake
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: sandbox
            path: sandbox
            attr: sandbox
          - name: desktop
            path: dioxus-desktop
            attr: desktop
          - name: hypervisor
            path: hypervisor
            attr: hypervisor

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Configure FlakeHub cache
        uses: DeterminateSystems/flakehub-cache-action@v3
        with:
          flakehub-flake-name: choir/choiros-rs
        env:
          FLAKEHUB_AUTH_TOKEN: ${{ secrets.FLAKEHUB_AUTH_TOKEN }}

      - name: Build flake package
        run: nix build "./${{ matrix.path }}#${{ matrix.attr }}" --print-build-logs

  deploy-ec2:
    name: Deploy EC2 via AWS SSM
    runs-on: ubuntu-latest
    needs: [nix-build]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: production
    env:
      AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
      DEPLOY_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      DEPLOY_SHA: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Configure FlakeHub cache
        uses: DeterminateSystems/flakehub-cache-action@v3
        with:
          flakehub-flake-name: choir/choiros-rs
        env:
          FLAKEHUB_AUTH_TOKEN: ${{ secrets.FLAKEHUB_AUTH_TOKEN }}

      - name: Validate SSM target
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_INSTANCE_ID}" ]; then
            echo "Missing EC2_INSTANCE_ID secret"
            exit 1
          fi

          aws ssm describe-instance-information \
            --region "${AWS_REGION}" \
            --filters "Key=InstanceIds,Values=${DEPLOY_INSTANCE_ID}" \
            --query 'InstanceInformationList[0].PingStatus' \
            --output text | grep -q '^Online$'

      - name: Deploy via SSM
        run: |
          set -euo pipefail

          SCRIPT_B64="$(base64 -w0 <<'EOF'
          set -euo pipefail
          RELEASE_SHA="${DEPLOY_SHA}"
          WORKDIR='/opt/choiros/workspace'
          cd "$WORKDIR"
          git fetch origin
          git checkout -f "$RELEASE_SHA"

          nix --extra-experimental-features nix-command --extra-experimental-features flakes build ./sandbox#sandbox
          nix --extra-experimental-features nix-command --extra-experimental-features flakes build ./hypervisor#hypervisor
          nix --extra-experimental-features nix-command --extra-experimental-features flakes develop ./dioxus-desktop --command bash -lc 'cd dioxus-desktop && dx build --release'

          install -m 0755 ./sandbox/result/bin/sandbox /opt/choiros/bin/sandbox
          install -m 0755 ./hypervisor/result/bin/hypervisor /opt/choiros/bin/hypervisor
          install -m 0755 ./dioxus-desktop/result/bin/sandbox-ui /opt/choiros/bin/sandbox-ui

          systemctl restart container@sandbox-live container@sandbox-dev hypervisor
          sleep 3
          curl -fsS http://127.0.0.1:9090/health >/dev/null
          echo "Deploy OK for $RELEASE_SHA"
          EOF
          )"

          COMMAND_ID="$(aws ssm send-command \
            --region "${AWS_REGION}" \
            --instance-ids "${DEPLOY_INSTANCE_ID}" \
            --document-name 'AWS-RunShellScript' \
            --comment "choiros deploy ${DEPLOY_SHA}" \
            --parameters commands="echo ${SCRIPT_B64} | base64 -d | DEPLOY_SHA='${DEPLOY_SHA}' bash" \
            --query 'Command.CommandId' \
            --output text)"

          aws ssm wait command-executed \
            --region "${AWS_REGION}" \
            --command-id "${COMMAND_ID}" \
            --instance-id "${DEPLOY_INSTANCE_ID}"

          aws ssm get-command-invocation \
            --region "${AWS_REGION}" \
            --command-id "${COMMAND_ID}" \
            --instance-id "${DEPLOY_INSTANCE_ID}" \
            --query '{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}' \
            --output json

      - name: Publish rollback notes
        run: |
          {
            echo "## Rollback quick path"
            echo
            echo "- EC2 host rollback: \`sudo nixos-rebuild switch --rollback\`"
            echo "- EC2 host generation list: \`sudo nix-env --list-generations --profile /nix/var/nix/profiles/system\`"
            echo "- Release commit: \`${{ github.sha }}\`"
            echo "- Repo path on host: \`/opt/choiros/workspace\`"
            echo "- Service restart after rollback: \`sudo systemctl restart container@sandbox-live container@sandbox-dev hypervisor\`"
          } >> "$GITHUB_STEP_SUMMARY"
