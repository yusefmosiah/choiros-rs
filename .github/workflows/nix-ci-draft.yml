name: Nix CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: nix-ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nix-build:
    name: Build ${{ matrix.name }} flake
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: sandbox
            path: sandbox
            attr: sandbox
          - name: desktop
            path: dioxus-desktop
            attr: desktop
          - name: hypervisor
            path: hypervisor
            attr: hypervisor

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Configure FlakeHub cache
        uses: DeterminateSystems/flakehub-cache-action@v3
        with:
          flakehub-flake-name: choir/choiros-rs
        env:
          FLAKEHUB_AUTH_TOKEN: ${{ secrets.FLAKEHUB_AUTH_TOKEN }}

      - name: Build flake package
        run: nix build "./${{ matrix.path }}#${{ matrix.attr }}" --print-build-logs

  deploy-ec2:
    name: Deploy EC2 via AWS SSM
    runs-on: ubuntu-latest
    needs: [nix-build]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: production
    env:
      AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
      DEPLOY_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      DEPLOY_SHA: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Configure FlakeHub cache
        uses: DeterminateSystems/flakehub-cache-action@v3
        with:
          flakehub-flake-name: choir/choiros-rs
        env:
          FLAKEHUB_AUTH_TOKEN: ${{ secrets.FLAKEHUB_AUTH_TOKEN }}

      - name: Validate SSM target
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_INSTANCE_ID}" ]; then
            echo "Missing EC2_INSTANCE_ID secret"
            exit 1
          fi

          aws ssm describe-instance-information \
            --region "${AWS_REGION}" \
            --filters "Key=InstanceIds,Values=${DEPLOY_INSTANCE_ID}" \
            --query 'InstanceInformationList[0].PingStatus' \
            --output text | grep -q '^Online$'

      - name: Deploy via SSM
        run: |
          set -euo pipefail

          SCRIPT_B64="$(base64 -w0 <<'EOF'
          set -euo pipefail
          RELEASE_SHA="${DEPLOY_SHA}"
          WORKDIR='/opt/choiros/deploy-repo'
          REPO_URL='https://github.com/yusefmosiah/choiros-rs.git'
          SANDBOX_OUT="$WORKDIR/result-sandbox"
          HYPERVISOR_OUT="$WORKDIR/result-hypervisor"
          DESKTOP_OUT="$WORKDIR/result-desktop"
          if [ ! -d "$WORKDIR/.git" ]; then
            rm -rf "$WORKDIR"
            git clone "$REPO_URL" "$WORKDIR"
          fi
          cd "$WORKDIR"
          git fetch origin
          git checkout -f "$RELEASE_SHA"

          rm -f "$SANDBOX_OUT" "$HYPERVISOR_OUT" "$DESKTOP_OUT"
          nix --extra-experimental-features nix-command --extra-experimental-features flakes build ./sandbox#sandbox --out-link "$SANDBOX_OUT"
          nix --extra-experimental-features nix-command --extra-experimental-features flakes build ./hypervisor#hypervisor --out-link "$HYPERVISOR_OUT"
          nix --extra-experimental-features nix-command --extra-experimental-features flakes build ./dioxus-desktop#desktop --out-link "$DESKTOP_OUT"

          install -m 0755 "$SANDBOX_OUT/bin/sandbox" /opt/choiros/bin/sandbox-real
          install -m 0755 "$HYPERVISOR_OUT/bin/hypervisor" /opt/choiros/bin/hypervisor
          install -m 0755 "$DESKTOP_OUT/bin/sandbox-ui" /opt/choiros/bin/sandbox-ui

          SANDBOX_BIN_STORE_PATH="$(readlink -f "$SANDBOX_OUT/bin/sandbox")"
          ONNX_STORE_PATH="$(nix-store -q --references "$SANDBOX_BIN_STORE_PATH" | grep 'onnxruntime' | head -n 1 || true)"
          if [ -z "$ONNX_STORE_PATH" ]; then
            echo "Failed to determine onnxruntime path from sandbox closure"
            exit 1
          fi
          ONNX_DYLIB_PATH="$ONNX_STORE_PATH/lib/libonnxruntime.so"

          cat >/opt/choiros/bin/sandbox <<EOF_WRAPPER
          #!/usr/bin/env bash
          set -euo pipefail
          export ORT_DYLIB_PATH="$ONNX_DYLIB_PATH"
          export LD_LIBRARY_PATH="$ONNX_STORE_PATH/lib:\${LD_LIBRARY_PATH:-}"
          exec /opt/choiros/bin/sandbox-real "\$@"
          EOF_WRAPPER
          chmod 0755 /opt/choiros/bin/sandbox

          systemctl restart container@sandbox-live container@sandbox-dev hypervisor

          wait_http() {
            local url="$1"
            local timeout_secs="$2"
            local started_at
            started_at="$(date +%s)"

            while true; do
              if curl -fsS "$url" >/dev/null; then
                return 0
              fi

              if [ $(( $(date +%s) - started_at )) -ge "$timeout_secs" ]; then
                echo "Timed out waiting for $url"
                systemctl status hypervisor --no-pager -l || true
                systemctl status container@sandbox-live --no-pager -l || true
                systemctl status container@sandbox-dev --no-pager -l || true
                return 1
              fi

              sleep 2
            done
          }

          wait_http http://127.0.0.1:9090/login 120
          wait_http http://127.0.0.1:8080/health 120
          wait_http http://127.0.0.1:8081/health 120
          echo "Deploy OK for $RELEASE_SHA"
          EOF
          )"

          COMMAND_ID="$(aws ssm send-command \
            --region "${AWS_REGION}" \
            --instance-ids "${DEPLOY_INSTANCE_ID}" \
            --document-name 'AWS-RunShellScript' \
            --comment "choiros deploy ${DEPLOY_SHA}" \
            --parameters "$(jq -cn --arg cmd "echo ${SCRIPT_B64} | base64 -d | DEPLOY_SHA='${DEPLOY_SHA}' bash" '{commands: [$cmd]}')" \
            --query 'Command.CommandId' \
            --output text)"

          for _ in $(seq 1 120); do
            STATUS="$(aws ssm get-command-invocation \
              --region "${AWS_REGION}" \
              --command-id "${COMMAND_ID}" \
              --instance-id "${DEPLOY_INSTANCE_ID}" \
              --query 'Status' \
              --output text 2>/dev/null || true)"

            case "$STATUS" in
              Success)
                break
                ;;
              Failed|Cancelled|TimedOut)
                echo "SSM command ended with status: $STATUS"
                aws ssm get-command-invocation \
                  --region "${AWS_REGION}" \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${DEPLOY_INSTANCE_ID}" \
                  --output json
                exit 1
                ;;
              *)
                sleep 10
                ;;
            esac
          done

          if [ "${STATUS:-}" != "Success" ]; then
            echo "SSM command did not reach Success within timeout window (last status: ${STATUS:-unknown})"
            aws ssm get-command-invocation \
              --region "${AWS_REGION}" \
              --command-id "${COMMAND_ID}" \
              --instance-id "${DEPLOY_INSTANCE_ID}" \
              --output json || true
            exit 1
          fi

          aws ssm get-command-invocation \
            --region "${AWS_REGION}" \
            --command-id "${COMMAND_ID}" \
            --instance-id "${DEPLOY_INSTANCE_ID}" \
            --query '{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}' \
            --output json

      - name: Publish rollback notes
        run: |
          {
            echo "## Rollback quick path"
            echo
            echo "- EC2 host rollback: \`sudo nixos-rebuild switch --rollback\`"
            echo "- EC2 host generation list: \`sudo nix-env --list-generations --profile /nix/var/nix/profiles/system\`"
            echo "- Release commit: \`${{ github.sha }}\`"
            echo "- Repo path on host: \`/opt/choiros/workspace\`"
            echo "- Service restart after rollback: \`sudo systemctl restart container@sandbox-live container@sandbox-dev hypervisor\`"
          } >> "$GITHUB_STEP_SUMMARY"
