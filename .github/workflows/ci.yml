name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SQLX_OFFLINE: "true"
  DATABASE_URL: "sqlite:./data/events.db"

jobs:
  # Backend unit and integration tests
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build backend
      run: cargo build -p sandbox --verbose
    
    - name: Run unit and integration tests
      run: cargo test -p sandbox --verbose

  # Frontend build verification
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install Dioxus CLI
      run: cargo install dioxus-cli
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build frontend
      run: |
        cd sandbox-ui
        cargo build --verbose

  # E2E tests (optional - requires servers running)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install Dioxus CLI
      run: cargo install dioxus-cli
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install E2E dependencies
      run: |
        cd tests/e2e
        pip install -r requirements.txt
        playwright install chromium
    
    - name: Start backend server
      run: |
        cargo run -p sandbox &
        echo $! > backend.pid
        # Wait for server to start
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "Backend is ready"
            break
          fi
          sleep 1
        done
    
    - name: Start frontend server
      run: |
        cd sandbox-ui
        dx serve &
        echo $! > ../frontend.pid
        # Wait for server to start
        for i in {1..30}; do
          if curl -s http://localhost:5173 > /dev/null 2>&1; then
            echo "Frontend is ready"
            break
          fi
          sleep 1
        done
        cd ..
    
    - name: Run E2E tests
      run: |
        cd tests/e2e
        pytest -v --headed=false
      continue-on-error: true
    
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-screenshots
        path: tests/e2e/screenshots/
        retention-days: 5
    
    - name: Cleanup servers
      if: always()
      run: |
        if [ -f backend.pid ]; then kill $(cat backend.pid) || true; fi
        if [ -f frontend.pid ]; then kill $(cat frontend.pid) || true; fi

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Check formatting
      run: cargo fmt -- --check
    
    - name: Run clippy
      run: cargo clippy -- -D warnings
