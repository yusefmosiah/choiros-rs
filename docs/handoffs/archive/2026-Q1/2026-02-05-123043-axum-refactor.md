# Handoff: Axum Refactor In Sandbox

## Session Metadata
- Created: 2026-02-05 12:30:43
- Project: /Users/wiz/choiros-rs
- Branch: main
- Session duration: ~2h

### Recent Commits (for context)
  - b8fa802 Restore app interactivity via chat WS
  - e2f23af Add terminal UI integration and E2E smoke
  - 4ec9d58 terminal ui doc
  - f1ce9c9 Add terminal WS smoke test
  - eb170e6 remove actorcode and progress with terminalactor

## Handoff Chain

- **Continues from**: [2026-02-04-213859-frontend-apps-broken.md](./2026-02-04-213859-frontend-apps-broken.md)
  - Previous title: Frontend apps broken (chat WS + terminal focus)
- **Supersedes**: None

> Review the previous handoff for full context before filling this one.

## Current State Summary

Completed the core Actix -> Axum migration in `sandbox` for server bootstrap, REST handlers, and WebSockets, and updated tests to use Axum/Tower + tokio-tungstenite. Dependencies were upgraded to axum 0.8.8 (with ws), tower 0.5, and tower-http 0.6. Cleanup is complete: removed Actix deps from workspace/hypervisor, updated docs to reflect Axum/Ractor, and ran `cargo test -p sandbox` (passes with existing warnings). Remaining optional step is manual UI verification.

## Architecture Overview

- `ApiState` (Arc<AppState> + WsSessions) is the single shared state; handlers extract it via `State<ApiState>`.
- `api::router()` returns `Router<ApiState>` (missing state). `main` calls `.with_state(api_state)` before `axum::serve`.
- Desktop WS uses per-desktop session registry: `HashMap<desktop_id, HashMap<session_id, mpsc::UnboundedSender<Message>>>`.
- Chat WS uses a single async loop and tokio task per message to call `ChatAgentMsg::ProcessMessage`.

## Critical Files

| File | Purpose | Relevance |
|------|---------|-----------|
| ../sandbox/src/main.rs | Axum server bootstrap + CORS | Server entrypoint wiring and state setup |
| ../sandbox/src/api/mod.rs | Router builder + `ApiState` | Central routing and state type |
| ../sandbox/src/api/chat.rs | Chat REST handlers | Uses Axum extractors + responses |
| ../sandbox/src/api/desktop.rs | Desktop REST handlers | Uses Axum extractors + responses |
| ../sandbox/src/api/terminal.rs | Terminal REST + WS | Axum WS upgrade + PTY bridge |
| ../sandbox/src/api/websocket.rs | Desktop WS | Session registry + broadcast |
| ../sandbox/src/api/websocket_chat.rs | Chat WS | Streaming responses, ping/pong |
| ../sandbox/tests | HTTP + WS tests | Axum/Tower + tokio-tungstenite |
| ../sandbox/Cargo.toml | Dependencies | Axum 0.8.8 + tower updates |

## Key Patterns Discovered

- In axum 0.8, `Router<S>` means the router is missing state `S`; you must call `.with_state` before serving.
- WebSocket text frames require `Utf8Bytes` (`Message::Text(text.into())`).
- Tests use `tower::ServiceExt::oneshot` for HTTP and `tokio_tungstenite` for WS.

## Work Completed

### Tasks Finished

- [x] Migrate sandbox server bootstrap and router to axum 0.8
- [x] Port chat/desktop/terminal REST handlers to Axum extractors/responses
- [x] Port desktop/chat/terminal WebSocket handlers to Axum
- [x] Update sandbox tests to Axum/Tower + tokio-tungstenite
- [x] Remove legacy Actix server file (api main)
- [x] Upgrade dependencies to axum 0.8.8, tower 0.5, tower-http 0.6
- [x] Remove Actix deps from workspace and hypervisor
- [x] Update docs (README, architecture, testing, agents) to Axum/Ractor
- [x] Run `cargo test -p sandbox` (passes with warnings)

## Files Modified

| File | Changes | Rationale |
|------|---------|-----------|
| ../Cargo.toml | Remove Actix workspace deps | Eliminate unused Actix stack crates |
| ../hypervisor/Cargo.toml | Remove Actix deps | Hypervisor is stub; keep deps minimal |
| ../sandbox/src/main.rs | Axum serve + CORS + state wiring | Replace Actix server bootstrap |
| ../sandbox/src/api/mod.rs | Router builder + ApiState | Centralize Axum routes |
| ../sandbox/src/api/chat.rs | Axum REST handlers | Replace Actix macros/extractors |
| ../sandbox/src/api/desktop.rs | Axum REST handlers | Replace Actix macros/extractors |
| ../sandbox/src/api/terminal.rs | Axum WS + REST | Replace actix-ws handlers |
| ../sandbox/src/api/websocket.rs | Axum desktop WS | Replace actix-ws handler and sessions |
| ../sandbox/src/api/websocket_chat.rs | Axum chat WS | Replace actix-web-actors handler |
| ../sandbox/tests/chat_api_test.rs | Axum HTTP tests | Use `oneshot` + JSON parsing |
| ../sandbox/tests/desktop_api_test.rs | Axum HTTP tests | Use `oneshot` + JSON parsing |
| ../sandbox/tests/websocket_chat_test.rs | WS tests | Use tokio-tungstenite server/client |
| ../sandbox/tests/terminal_ws_smoketest.rs | WS smoke test | Use tokio-tungstenite |
| ../sandbox/Cargo.toml | Deps updated | Add axum 0.8.8 + tower versions |
| ../README.md | Stack update | Reflect Axum/Ractor in overview |
| ../AGENTS.md | Testing + deps update | Align guidance with Axum/Tower |
| ../docs/ARCHITECTURE_SPECIFICATION.md | Stack update | Replace Actix references |
| ../docs/TESTING_STRATEGY.md | Testing update | Axum/Tower test patterns |
| ../docs/axum-migration-plan.md | Status note | Mark plan as completed |
| ../docs/handoffs/2026-02-05-123043-axum-refactor.md | Status update | Record cleanup + tests |

## Decisions Made

| Decision | Options Considered | Rationale |
|----------|-------------------|-----------|
| Upgrade to axum 0.8.8 | Stay on 0.7.x vs 0.8.x | Align with latest API and avoid 0.7 migration churn |
| Provide state at serve time (`with_state`) | Build router with state directly | Matches axum 0.8 semantics (`Router<S>` missing state) |
| Use tokio-tungstenite in WS tests | Keep actix ws client | Clean Axum-native stack |
| Use per-desktop session registry | Keep actix session clones | Axum WS sockets are not cloneable |

## Immediate Next Steps

1. Run `just dev-sandbox` + `just dev-ui` to verify `/health`, desktop WS, chat WS, and terminal WS in the UI.

## Blockers/Open Questions

- None currently.

## Deferred Items

- Cleanup of dead-code warnings and unused re-exports (not related to migration correctness).

## Important Context

- `api::router()` now returns `Router<ApiState>` (missing state). You must call `.with_state(api_state)` before serving; `axum::serve(listener, app)` expects `Router<()>`.
- Axum 0.8 WebSocket `Message::Text` expects `Utf8Bytes`. Use `.into()` when sending strings.
- `cargo check -p sandbox` passes; `cargo test -p sandbox` passes with warnings (dead code/unused).
- Legacy api main file was deleted; main server is now `../sandbox/src/main.rs` only.

## Assumptions Made

- Axum 0.8.8 is acceptable and compatible with the rest of the workspace.
- No auth changes required during migration; handlers remain permissive.

## Potential Gotchas

- Axum 0.8 uses different state semantics than 0.7; `Router<ApiState>` is missing state.
- WS tests require tokio-tungstenite and the `ws` feature on axum.
- There are multiple axum versions in the dependency tree (tonic pulls 0.6); avoid mixing imports.

## Environment State

### Tools/Services Used

- `cargo check -p sandbox`
- `cargo test -p sandbox`
- `python skills/session-handoff/scripts/create_handoff.py`

### Active Processes

- None.

### Environment Variables

- None.

## Related Resources

- axum-migration-plan.md
- ../sandbox/src/main.rs
- ../sandbox/src/api/mod.rs
- ../sandbox/src/api/websocket.rs
- ../sandbox/src/api/websocket_chat.rs
- ../sandbox/src/api/terminal.rs
- ../sandbox/tests/websocket_chat_test.rs

---

**Security Reminder**: Before finalizing, run `validate_handoff.py` to check for accidental secret exposure.
