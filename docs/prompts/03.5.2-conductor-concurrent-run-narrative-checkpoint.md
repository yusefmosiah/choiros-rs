# Prompt 03.5.2: Concurrent Run Narrative Checkpoint (Post-03.5.1)

You are working in `/Users/wiz/choiros-rs`.

## Narrative Summary (1-minute read)
`03.5.1` established BAML policy authority for Conductor and Watcher. `03.5.2` must now prove true concurrent orchestration and run-centric narrative behavior.  
Conductor is orchestration authority but should not spend tokens on routine chatter. Watcher/UI lanes handle routine events; Conductor wakes on high-value triggers and replans from typed state + run narrative.

## What Changed
- `03.5.1` is now baseline: no deterministic fallback authority.
- This prompt shifts focus to concurrent worker execution and narrative accumulation.
- Primary UX remains semantic run progress and natural-language summary, with raw logs as drill-down.
- Wake optimization and eval-driven tuning are deferred until after this checkpoint.

## What To Do Next
Implement baseline concurrent orchestration and semantic progress surfaces, then stop.
Do not optimize wake heuristics yet.

## Mission
Deliver a basic working state where:
1. multiple workers run concurrently without blocking Conductor,
2. Conductor can always poll/pull canonical run state,
3. semantic run events and accumulated run description are first-class outputs,
4. Conductor reads run description on wake, but typed outputs remain control authority.

## Hard Rules
1. Follow AGENTS.md `NO ADHOC WORKFLOW`.
2. No deterministic fallback orchestration paths.
3. No fixed worker order authority.
4. Typed contracts govern control transitions.
5. Raw logs remain available, but semantic run view is default.

## Required Behavior
### A) Concurrency Baseline
- Dispatch ready agenda items in parallel.
- Worker calls are asynchronous and non-blocking.
- Duplicate dispatch protection remains enforced.
- Conductor must not require a `Terminal -> Researcher` sequence. Order emerges from typed agenda state and policy decisions.

### B) Canonical State Pull
- Conductor wake path can always reconstruct decision context from:
  - run state (`run/agenda/calls/artifacts/decisions`),
  - latest semantic events,
  - accumulated run description.

### C) Semantic Progress Layer
- Emit high-signal semantic events (`finding`, `evidence`, `test.result`, `decision`, `artifact`, `blocker`, `milestone`).
- Maintain an accumulated natural-language run description as run context.
- Expose semantic summary as primary UI feed; raw event stream as drill-down.
- Ensure run narrative can be read by both:
  - Conductor wake context,
  - user-facing run surface.

### D) Wake Baseline (Checkpoint Policy)
- Wake Conductor on:
  - run start,
  - capability successful completion,
  - watcher escalation.
- Keep routine progress in watcher/UI lanes unless escalated.
- If wake signaling is imperfect, Conductor must still recover by polling/pulling canonical run state.

## Non-Goals (For This Prompt)
1. Final wake efficiency tuning.
2. Prompt/model optimization loops (DSPy/evals tuning).
3. Broad UX polish beyond semantic default surface.

## Acceptance Criteria
1. At least two capabilities can execute concurrently in one run.
2. Conductor can replan from canonical state pull even if watcher heuristics are simple.
3. Semantic run summary is visible and continuously updated.
4. Conductor wake context includes run description.
5. No deterministic fallback path executes under failures.
6. Unknown or unscoped watcher escalations do not trigger invalid conductor wake actions.

## Validation
Run and report:
- `cargo check -p sandbox`
- `cargo test -p sandbox --lib conductor::actor -- --nocapture`
- `cargo test -p sandbox --lib conductor::state -- --nocapture`
- `cargo test -p sandbox --lib watcher -- --nocapture`

If websocket/output contracts changed:
- `cargo test -p sandbox --test websocket_chat_test -- --nocapture`

## Final Summary Requirements
Include:
1. files changed,
2. proof of concurrent dispatch behavior,
3. proof conductor wake reads run description context,
4. proof semantic run progress is primary surface,
5. tests run and outcomes,
6. explicit statement of any remaining deterministic authority (must be none).
