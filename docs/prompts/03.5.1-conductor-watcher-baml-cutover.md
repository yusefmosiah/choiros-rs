# Prompt 03.5.1: Conductor + Watcher BAML Cutover (No Deterministic Fallbacks)

You are working in `/Users/wiz/choiros-rs`.

## Narrative Summary (1-minute read)
Conductor and Watcher must move to an explicit BAML-driven policy architecture. Conductor remains orchestration authority and delegates natural-language objectives to capability agents (`terminal`, `researcher`, future capabilities), while typed outputs control state transitions. Watcher becomes LLM-driven for scoped event-log review using lower-power models than Conductor.

Deterministic workflow authority and deterministic fallback behavior must be removed.

## What Changed
- Typed runtime state for Conductor is in place (`run/agenda/calls/artifacts/decisions`).
- Wake/display lanes and telemetry contracts are in place.
- Architecture correction now requires:
  - Conductor BAML policy functions,
  - Watcher BAML review/triage functions,
  - no deterministic workflow authority,
  - no deterministic fallback path.

## What To Do Next
Implement the full Conductor+Watcher BAML cutover:
1. add BAML contracts,
2. integrate those contracts into runtime loops,
3. enforce typed fail-fast behavior on policy/model failure,
4. delete deterministic orchestration authority.

## Mission
Cut over orchestration to a typed, agentic, BAML-backed control loop where:
1. Conductor decides actions from typed run/event snapshots,
2. Conductor sends natural-language objectives to capability workers,
3. Watcher reviews scoped EventStore windows using lower-power models,
4. Watcher emits typed escalation outputs into Conductor wake lane,
5. no deterministic fallback executes under failure conditions.

## Architecture Requirements (Hard Rules)
1. Follow AGENTS.md `Model-Led Control Flow` hard rule.
2. No natural-language string matching for workflow state transitions.
3. No fixed worker order as orchestration authority.
4. Conductor delegation payloads are natural-language objectives.
5. Typed fields/messages/BAML outputs hold control authority.
6. Watcher model policy must resolve to lower-power models than Conductor.
7. Deterministic fallback paths are prohibited.
8. Policy/model failures must produce explicit typed run failure/block transitions.

## Read First
- `/Users/wiz/choiros-rs/AGENTS.md`
- `/Users/wiz/choiros-rs/docs/architecture/2026-02-10-conductor-watcher-baml-cutover.md`
- `/Users/wiz/choiros-rs/docs/prompts/03.5-conductor-agentic-readiness-before-writer-prompt-loop.md`
- `/Users/wiz/choiros-rs/docs/prompts/03.6-conductor-wake-dispatch-loop-hardening.md`
- `/Users/wiz/choiros-rs/baml_src/agent.baml`
- `/Users/wiz/choiros-rs/baml_src/types.baml`
- `/Users/wiz/choiros-rs/sandbox/src/baml_client/baml_source_map.rs`
- `/Users/wiz/choiros-rs/sandbox/src/actors/conductor/actor.rs`
- `/Users/wiz/choiros-rs/sandbox/src/actors/conductor/state.rs`
- `/Users/wiz/choiros-rs/sandbox/src/actors/conductor/protocol.rs`
- `/Users/wiz/choiros-rs/sandbox/src/actors/conductor/events.rs`
- `/Users/wiz/choiros-rs/sandbox/src/actors/watcher.rs`
- `/Users/wiz/choiros-rs/shared-types/src/lib.rs`

## Implement

### Phase A: Add Conductor BAML Contracts
Add typed BAML contracts for policy decisions:
- `ConductorDecideNextAction(input: ConductorDecisionInput) -> ConductorDecisionOutput`
- `ConductorRefineObjective(input: ConductorObjectiveRefineInput) -> ConductorObjectiveRefineOutput`
- `ConductorAssessTerminality(input: ConductorTerminalityInput) -> ConductorTerminalityOutput`

Ensure output decision enum is typed and closed-set:
- `dispatch`
- `retry`
- `spawn_followup`
- `continue`
- `complete`
- `block`

### Phase B: Add Watcher BAML Contracts
Add typed BAML contracts for event-log review and mitigation:
- `WatcherReviewLogWindow(input: WatcherLogWindowInput) -> WatcherReviewOutput`
- `WatcherRecommendMitigation(input: WatcherMitigationInput) -> WatcherMitigationOutput`

Watcher outputs must include typed:
- escalations/actions
- urgency
- rationale
- confidence
- recommended capability/objective (when relevant)

### Phase C: BAML Sync + Client Generation
Update `baml_src` and regenerate BAML client artifacts.

Keep these synchronized:
- `baml_src/*.baml`
- generated client files in `sandbox/src/baml_client/`
- `sandbox/src/baml_client/baml_source_map.rs`

### Phase D: Conductor Runtime Cutover
Wire Conductor runtime to BAML policy functions for control decisions.

Required behavior:
- `worker_plan` may seed initial agenda, but is not immutable execution authority.
- Remove deterministic workflow authority from `build_default_plan` and fixed-loop execution path.
- `ProcessEvent` + `DispatchReady` must drive runtime through typed decisions + typed state transitions.
- Capability calls receive natural-language objectives authored/refined by Conductor policy.

### Phase E: Watcher Runtime Cutover
Wire Watcher to run LLM-driven review over scoped EventStore windows.

Required behavior:
- review input is replayable event slices,
- watcher outputs are typed and auditable,
- watcher escalations flow into Conductor wake lane.

### Phase F: Model Policy Enforcement
Implement explicit model policy constraints:
- Conductor policy functions use Conductor-tier model policy.
- Watcher review/triage functions use lower-power watcher-tier model policy.

Add tests proving this resolution behavior.

### Phase G: Failure Behavior (No Deterministic Fallback)
On policy/model invocation failure:
- do not run deterministic fallback sequence,
- emit typed failure events with reason/context,
- transition run state explicitly to `failed` or `blocked` based on typed rules.

### Phase H: Observability
For each policy call, emit typed observability events including:
- model/provider
- function name
- decision/review type
- confidence
- correlation/run/task/call identity

## Explicit Non-Goals
- Implementing Prompt 04 writer patch-apply loop.
- Restoring deterministic execution as “temporary” control logic.
- Chat-specific orchestration hacks.

## Acceptance Criteria
1. Conductor and Watcher BAML contracts are implemented and used in runtime paths.
2. Conductor control decisions are policy-driven and typed.
3. Watcher performs LLM-driven log review and emits typed escalation outputs.
4. Watcher model tier is lower-power than Conductor model tier.
5. Conductor delegates natural-language objectives to capabilities.
6. Deterministic workflow authority is removed.
7. Deterministic fallback paths do not execute under policy/model failure.
8. Policy failures yield explicit typed run failure/block transitions.

## Testing Requirements
Add focused tests for:
- BAML contract decode/encode correctness (Conductor + Watcher),
- Conductor replanning from typed worker outcomes (`Incomplete`, `Blocked`, recommendations),
- Watcher review output ingestion into Conductor wake path,
- model policy tiering (`Watcher < Conductor`),
- failure-path behavior showing no deterministic fallback execution,
- duplicate-dispatch protection and terminal convergence.

Add at least one integration-style test timeline:
`StartRun -> Conductor policy decision -> capability dispatch -> watcher review escalation -> replan -> terminal status`.

## Validation
Run and report exact commands:
- `cargo test -p sandbox --lib`
- `cargo test -p sandbox --lib conductor::actor -- --nocapture`
- `cargo test -p sandbox --lib conductor::state -- --nocapture`
- `cargo test -p sandbox --lib conductor::events -- --nocapture`
- `cargo test -p sandbox --lib watcher -- --nocapture`

If websocket/event streams are impacted:
- `cargo test -p sandbox --test websocket_chat_test -- --nocapture`

## Final Summary Requirements
Include:
- files changed,
- BAML contracts added/updated (Conductor and Watcher),
- runtime cutover points,
- proof of removed deterministic authority,
- proof of no deterministic fallback behavior,
- tests run and outcomes.
